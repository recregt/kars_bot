name: Cargo Dist Preview

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install musl target
        run: rustup target add x86_64-unknown-linux-musl

      - name: Install musl C toolchain
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Download cargo-dist binary
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL -o /tmp/cargo-dist.tar.xz \
            https://github.com/axodotdev/cargo-dist/releases/latest/download/cargo-dist-x86_64-unknown-linux-musl.tar.xz
          tar -xJf /tmp/cargo-dist.tar.xz -C /tmp
          install -m 0755 /tmp/cargo-dist-x86_64-unknown-linux-musl/dist /usr/local/bin/dist

      - name: Validate dist plan
        run: dist plan --target x86_64-unknown-linux-musl --allow-dirty

      - name: Build preview distributables
        run: dist build --artifacts=all --target=x86_64-unknown-linux-musl --allow-dirty

      - name: Generate dist manifest
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/distrib
          dist -o json manifest --target=x86_64-unknown-linux-musl --allow-dirty > target/distrib/dist-manifest.json

      - name: Summarize dist plan
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## Cargo-dist Preview"
            echo
            echo "- dist version: $(dist --version)"
            echo "- target: x86_64-unknown-linux-musl"
            echo "- config: dist-workspace.toml"
            echo "- built artifacts:"
            ls -1 target/distrib || true
          } >> "$GITHUB_STEP_SUMMARY"
