name: Release Plz Preview

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2

      - name: Download release-plz binary
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL -o /tmp/release-plz.tar.gz \
            https://github.com/release-plz/release-plz/releases/latest/download/release-plz-x86_64-unknown-linux-musl.tar.gz
          tar -xzf /tmp/release-plz.tar.gz -C /tmp
          install -m 0755 /tmp/release-plz /usr/local/bin/release-plz

      - name: Prepare previous tag manifest
        id: prev_tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          prev_tag="$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)"
          if [[ -z "$prev_tag" ]]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git worktree add /tmp/release-plz-prev-tag "$prev_tag"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "tag=$prev_tag" >> "$GITHUB_OUTPUT"

      - name: Run release-plz update preview
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ steps.prev_tag.outputs.found }}" == "true" ]]; then
            release-plz update \
              --config release-plz.toml \
              --allow-dirty \
              --registry-manifest-path /tmp/release-plz-prev-tag/Cargo.toml
          else
            release-plz update --config release-plz.toml --allow-dirty
          fi

      - name: Summarize release-plz output
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## Release-plz Preview"
            if [[ "${{ steps.prev_tag.outputs.found }}" == "true" ]]; then
              echo
              echo "- Previous tag baseline: ${{ steps.prev_tag.outputs.tag }}"
            else
              echo
              echo "- Previous tag baseline: not found"
            fi
            echo
            echo "### Changed files"
            git status --short || true
            echo
            echo "### Cargo.toml version"
            grep '^version = ' Cargo.toml || true
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup worktree
        if: always()
        run: git worktree remove /tmp/release-plz-prev-tag --force || true
