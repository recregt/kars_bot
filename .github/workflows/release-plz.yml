name: Release Plz

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-plz-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-pr:
    runs-on: ubuntu-latest
    env:
      RELEASE_PLZ_TOKEN: ${{ secrets.RELEASE_PLZ_TOKEN }}
      RELEASE_PLZ_AUTO_TAG: ${{ vars.RELEASE_PLZ_AUTO_TAG || 'true' }}

    steps:
      - name: Validate release-plz token configuration
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${RELEASE_PLZ_TOKEN}" ]]; then
            echo "::error::Missing RELEASE_PLZ_TOKEN secret. Configure a PAT or GitHub App token so release-plz PRs trigger required pull_request checks."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release-plz binary
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL -o /tmp/release-plz.tar.gz \
            https://github.com/release-plz/release-plz/releases/download/release-plz-v0.3.156/release-plz-x86_64-unknown-linux-musl.tar.gz
          tar -xzf /tmp/release-plz.tar.gz -C /tmp
          install -m 0755 /tmp/release-plz /usr/local/bin/release-plz

      - name: Prepare previous tag baseline
        id: prev_tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          prev_tag="$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)"
          if [[ -z "$prev_tag" ]]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git worktree add /tmp/release-plz-prev-tag "$prev_tag"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "tag=$prev_tag" >> "$GITHUB_OUTPUT"

      - name: Run release-plz release-pr
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ steps.prev_tag.outputs.found }}" == "true" ]]; then
            release-plz release-pr \
              --config release-plz.toml \
              --git-token "$RELEASE_PLZ_TOKEN" \
              --registry-manifest-path /tmp/release-plz-prev-tag/Cargo.toml
          else
            release-plz release-pr --config release-plz.toml --git-token "$RELEASE_PLZ_TOKEN"
          fi

      - name: Ensure version tag exists after main push
        if: github.event_name == 'push' && env.RELEASE_PLZ_AUTO_TAG != 'false'
        id: ensure_tag
        shell: bash
        run: |
          set -euo pipefail

          before_sha="${{ github.event.before }}"
          after_sha="${{ github.sha }}"

          if [[ -z "$before_sha" || "$before_sha" == "0000000000000000000000000000000000000000" ]]; then
            echo "No valid before SHA; skipping automatic tag check."
            echo "tag_created=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! git diff --unified=0 "$before_sha" "$after_sha" -- Cargo.toml | grep -Eq '^[+-]version = "[0-9]+\.[0-9]+\.[0-9]+"'; then
            echo "Cargo.toml version unchanged in this push; no tag action required."
            echo "tag_created=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          version="$(git show "$after_sha":Cargo.toml | awk -F '"' '/^version = /{print $2; exit}')"
          if [[ -z "$version" ]]; then
            echo "::error::Could not read version from Cargo.toml at $after_sha"
            exit 1
          fi

          tag="v$version"
          git fetch --tags --force

          if git rev-parse -q --verify "refs/tags/$tag" >/dev/null; then
            echo "Tag $tag already exists; skipping."
            echo "tag_created=false" >> "$GITHUB_OUTPUT"
            echo "tag=$tag" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag" -m "Release $tag" "$after_sha"
          git push origin "refs/tags/$tag"
          echo "Created and pushed missing tag $tag"
          echo "tag_created=true" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Dispatch Release workflow for created tag
        if: github.event_name == 'push' && env.RELEASE_PLZ_AUTO_TAG != 'false' && steps.ensure_tag.outputs.tag_created == 'true'
        env:
          GH_TOKEN: ${{ env.RELEASE_PLZ_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.ensure_tag.outputs.tag }}"
          if [[ -z "$tag" ]]; then
            echo "::error::Expected tag output from ensure_tag step, but it was empty."
            exit 1
          fi
          gh workflow run release.yml --ref main -f tag="$tag"
          echo "Dispatched release.yml for $tag"

      - name: Cleanup worktree
        if: always()
        run: git worktree remove /tmp/release-plz-prev-tag --force || true
