name: Tag Version Verify

on:
  push:
    tags:
      - 'v*'

jobs:
  verify-tag-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Cargo.toml version matches tag
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          expected="${tag#v}"
          actual=$(git show "$tag":Cargo.toml | awk -F '"' '/^version = /{print $2; exit}')
          if [[ "$actual" != "$expected" ]]; then
            echo "::error::Tag $tag expects Cargo version $expected but found $actual"
            exit 1
          fi
          echo "Tag/Cargo version match verified: $tag -> $actual"
